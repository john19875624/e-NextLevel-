// ==UserScript==
// @name         e-NextLevel ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ãƒœã‚¿ãƒ³ (v1.9.2 Refactored)
// @namespace    http://tampermonkey.net/
// @version      1.9.2
// @description  ä½œæ¥­æ—¥ã¨é›†åˆï½çµ‚äº†æ™‚åˆ»ã‚’Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ç™»éŒ²ã™ã‚‹ï¼ˆç™»éŒ²æ¸ˆã¿è¡¨ç¤ºä»˜ãï¼‰ã€‚UIã§å–å¾—å€¤ç¢ºèªå¯èƒ½ã€ã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ãªã„ã€é›†åˆæ™‚é–“ï¼çµ‚äº†æ™‚åˆ»ãªã‚‰ç¿Œæ—¥è§£é‡ˆã€UIæ‹¡å¤§ã€æŒã¡ç‰©ã¨æœè£…ã‚’dl/dt/ddæ§‹é€ ã‹ã‚‰å–å¾—ã€‚é›†åˆå ´æ‰€ã‚’é™¤å»ã€‚èª­ã¿ã‚„ã™ã•ã‚’å‘ä¸Šã€‚
// @match        https://www.e-nextlevel.jp/work/detail/*
// @grant        GM_setValue
// @grant        GM_getValue
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';
    console.log('[e-NextLevel Calendar v1.9.2 Refactored] Script Started');

    // --- å®šæ•°å®šç¾© ---
    const JOB_ID_REGEX = /\/(\d+)$/;
    const REGISTERED_FLAG_PREFIX = 'calendar_registered_';
    // const DATETIME_FORMAT = "YYYYMMDDTHHmmss"; // Google Calendar format (simplified representation) - Not directly used, but good for reference

    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---

    /**
     * URLãƒ‘ã‚¹ã‹ã‚‰ã‚¸ãƒ§ãƒ–IDã‚’å–å¾—ã—ã¾ã™ã€‚
     * @returns {string|null} ã‚¸ãƒ§ãƒ–IDã¾ãŸã¯null
     */
    function getJobIdFromUrl() {
        const match = location.pathname.match(JOB_ID_REGEX);
        return match ? match[1] : null;
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã¨æ™‚åˆ»ã‚’Google Calendar APIãŒè¦æ±‚ã™ã‚‹å½¢å¼ã«è¿‘ã„æ–‡å­—åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã—ã¾ã™ã€‚
     * @param {string} dateStr - 'YYYY-MM-DD' å½¢å¼ã®æ—¥ä»˜æ–‡å­—åˆ—
     * @param {string} timeStr - 'HH:MM' å½¢å¼ã®æ™‚åˆ»æ–‡å­—åˆ—
     * @param {number} [dayAdjustment=0] - æ—¥ä»˜ã«åŠ ç®—ã™ã‚‹æ—¥æ•°ï¼ˆç¿Œæ—¥ã®å ´åˆãªã©ï¼‰
     * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸæ—¥ä»˜æ™‚åˆ»æ–‡å­—åˆ— (ä¾‹: '20230401T090000')ã€ã¾ãŸã¯ç©ºæ–‡å­—åˆ—
     */
    function formatDateTimeForCalendar(dateStr, timeStr, dayAdjustment = 0) {
        if (!dateStr || !timeStr) {
            console.warn('[e-NextLevel Calendar] Cannot format empty date or time.');
            return '';
        }
        try {
            const [year, month, day] = dateStr.split('-').map(Number);
            // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æœˆã‚’0ã‹ã‚‰æ•°ãˆã‚‹ãŸã‚ month - 1
            const dateObj = new Date(year, month - 1, day);
            if (isNaN(dateObj)) { // Check if the date is valid
                 console.error('[e-NextLevel Calendar] Invalid date string provided:', dateStr);
                 return '';
            }
            dateObj.setDate(dateObj.getDate() + dayAdjustment);

            const yyyy = dateObj.getFullYear();
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const time = timeStr.replace(/:/g, '');

            // Basic validation for time format
            if (!/^\d{4}$/.test(time)) {
                 console.error('[e-NextLevel Calendar] Invalid time string provided:', timeStr);
                 return '';
            }

            return `${yyyy}${mm}${dd}T${time}00`;
        } catch (e) {
            console.error('[e-NextLevel Calendar] Error formatting date/time:', dateStr, timeStr, e);
            return '';
        }
    }

    /**
     * é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‚’æ¯”è¼ƒã—ã€çµ‚äº†æ™‚åˆ»ãŒç¿Œæ—¥ã«ãªã‚‹ã‹åˆ¤æ–­ã—ã¾ã™ã€‚
     * @param {string} startTime - 'HH:MM' å½¢å¼ã®é–‹å§‹æ™‚åˆ»
     * @param {string} endTime - 'HH:MM' å½¢å¼ã®çµ‚äº†æ™‚åˆ»
     * @returns {number} çµ‚äº†æ—¥ãŒç¿Œæ—¥ã®å ´åˆã¯ 1, ãã‚Œä»¥å¤–ã¯ 0
     */
    function calculateEndTimeDayAdjustment(startTime, endTime) {
        if (!startTime || !endTime) return 0;
        try {
            const [startHour, startMinute] = startTime.split(':').map(Number);
            const [endHour, endMinute] = endTime.split(':').map(Number);

            if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour) || isNaN(endMinute)) {
                 console.error('[e-NextLevel Calendar] Invalid time format for comparison:', startTime, endTime);
                 return 0;
            }

            const startMinutes = startHour * 60 + startMinute;
            const endMinutes = endHour * 60 + endMinute;
            return startMinutes > endMinutes ? 1 : 0;
        } catch (e) {
            console.error('[e-NextLevel Calendar] Error comparing times:', startTime, endTime, e);
            return 0; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯èª¿æ•´ã—ãªã„
        }
    }

    /**
     * ãƒšãƒ¼ã‚¸ã‹ã‚‰ä»•äº‹ã®è©³ç´°æƒ…å ±ã‚’æŠ½å‡ºã—ã¾ã™ã€‚
     * @returns {object|null} æŠ½å‡ºã•ã‚ŒãŸä»•äº‹æƒ…å ±ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¾ãŸã¯æŠ½å‡ºå¤±æ•—æ™‚ã«null
     */
    function extractJobDetails() {
        try {
            const pageText = document.body.innerText; // Keep for date/time extraction if selectors fail

            // --- åŸºæœ¬æƒ…å ±ã®æŠ½å‡º (æ—¥ä»˜ã€æ™‚åˆ»ã€ã‚¿ã‚¤ãƒˆãƒ«) ---
            // æ—¥ä»˜: YYYYå¹´ MMæœˆ DDæ—¥ å½¢å¼
            const dateMatch = pageText.match(/(\d{4})å¹´\s*(\d{1,2})æœˆ\s*(\d{1,2})æ—¥/);
            const date = dateMatch ? `${dateMatch[1]}-${String(dateMatch[2]).padStart(2, '0')}-${String(dateMatch[3]).padStart(2, '0')}` : '';

            // ä½œæ¥­æ™‚é–“ç¯„å›²: HH:MMï½HH:MM å½¢å¼
            const timeRangeMatch = pageText.match(/(\d{1,2}):(\d{2})ï½(\d{1,2}):(\d{2})/);
            const endTime = timeRangeMatch ? `${String(timeRangeMatch[3]).padStart(2, '0')}:${timeRangeMatch[4]}` : '';

            // é–‹å§‹æ™‚åˆ»: 'ä½œæ¥­æ—¥å½“æ—¥ HH:MM' å½¢å¼ã‹ã‚‰æœ€ã‚‚æ—©ã„ã‚‚ã®ã‚’æ¢ã™ã€‚è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ä½œæ¥­æ™‚é–“ç¯„å›²ã®é–‹å§‹æ™‚åˆ»ã€‚
            const timeMatches = Array.from(pageText.matchAll(/ä½œæ¥­æ—¥å½“æ—¥\s*(\d{1,2}):(\d{2})/g));
            let startTime = '';
            if (timeMatches.length > 0) {
                 startTime = timeMatches.reduce((earliestTime, currentMatch) => {
                     const currentTimeStr = `${String(currentMatch[1]).padStart(2, '0')}:${currentMatch[2]}`;
                     return !earliestTime || currentTimeStr < earliestTime ? currentTimeStr : earliestTime;
                 }, null);
            } else if (timeRangeMatch) {
                 startTime = `${String(timeRangeMatch[1]).padStart(2, '0')}:${timeRangeMatch[2]}`;
            }

            // ã‚¿ã‚¤ãƒˆãƒ«
            const titleElement = document.querySelector('h2.jobDetailInfo__title');
            const title = titleElement?.innerText?.trim() || '';

            // --- è©³ç´°æƒ…å ±ã®æŠ½å‡º ---

            // ç¾å ´ä½æ‰€ (Selector needs verification/adjustment if site structure changes)
            const placeElement = document.querySelector('li.jobInfoList__item.is_place');
            const jobSiteAddress = placeElement?.innerText.trim() || '';

            // æœè£…ã¨æŒã¡ç‰© (dl/dt/ddæ§‹é€ ã«å¯¾å¿œ)
            let dressCode = '';
            let requiredItems = '';
            const detailTitles = document.querySelectorAll('dt.jobDetailOther__title');

            detailTitles.forEach(dtElement => {
                const titleText = dtElement.innerText.trim();
                const ddElement = dtElement.nextElementSibling; // dt ã®ç›´å¾Œã®è¦ç´ ã‚’å–å¾—

                // ddè¦ç´ ãŒå­˜åœ¨ã—ã€æœŸå¾…ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
                if (ddElement && ddElement.tagName === 'DD' && ddElement.classList.contains('jobDetailOther__cont')) {
                    const contentText = ddElement.innerText.trim();
                    if (titleText === 'æœè£…') {
                        dressCode = contentText;
                        console.log('[e-NextLevel Calendar] Found Dress Code:', dressCode);
                    } else if (titleText === 'æŒã¡ç‰©') {
                        requiredItems = contentText;
                        console.log('[e-NextLevel Calendar] Found Required Items:', requiredItems);
                    }
                } else {
                     console.log(`[e-NextLevel Calendar] Sibling DD for DT '${titleText}' not found or missing expected class.`);
                }
            });

            // å¿…é ˆæƒ…å ±ãŒå–å¾—ã§ãã¦ã„ã‚‹ã‹ç¢ºèª
            if (!date || !startTime || !endTime || !title) {
                 console.warn('[e-NextLevel Calendar] Essential information (date, time, title) could not be extracted. Date:', date, 'Start:', startTime, 'End:', endTime, 'Title:', title);
                 // Return null or partial object if essential info is missing? Currently returns partial.
            }

            return {
                date,
                startTime,
                endTime,
                title,
                jobSiteAddress, // NOTE: Selector needs verification if site structure changes
                // meetingPlace removed as requested
                requiredItems,
                dressCode
            };
        } catch (e) {
            console.error('[e-NextLevel Calendar] Error extracting job details:', e);
            return null;
        }
    }

    /**
     * Google Calendarç™»éŒ²ç”¨ã®URLã‚’ç”Ÿæˆã—ã¾ã™ã€‚
     * @param {object} jobDetails - extractJobDetailsã‹ã‚‰è¿”ã•ã‚ŒãŸä»•äº‹æƒ…å ±
     * @returns {string} Google Calendarã®URLæ–‡å­—åˆ—ã€ã¾ãŸã¯ç©ºæ–‡å­—åˆ—
     */
    function generateCalendarUrl(jobDetails) {
        if (!jobDetails) {
             console.error('[e-NextLevel Calendar] Cannot generate URL without job details.');
             return '';
        }

        const {
            date, startTime, endTime, title, jobSiteAddress, requiredItems, dressCode
            // meetingPlace removed
        } = jobDetails;

        // Check for essential details needed for the URL
        if (!date || !startTime || !endTime || !title) {
            console.warn('[e-NextLevel Calendar] Missing essential details (date, time, title) for URL generation.');
            return '';
        }

        // çµ‚äº†æ™‚åˆ»ãŒç¿Œæ—¥ã«ãªã‚‹ã‹è¨ˆç®—
        const endTimeDayAdjustment = calculateEndTimeDayAdjustment(startTime, endTime);

        // URLã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
        const calendarUrl = new URL('https://calendar.google.com/calendar/render');
        calendarUrl.searchParams.set('action', 'TEMPLATE');

        // ã‚¿ã‚¤ãƒˆãƒ«
        calendarUrl.searchParams.set('text', title); // Title is mandatory for a useful event

        // è©³ç´° (Description) - Including required items and dress code as requested
        const itemsText = requiredItems ? `æŒã¡ç‰©:\n${requiredItems}` : '';
        const attireText = dressCode ? `æœè£…:\n${dressCode}` : '';
        // Join items and attire only if at least one exists, with a separator
        const itemsAndAttire = [itemsText, attireText].filter(Boolean).join('\n\n');

        const detailsLines = [
            location.href ? `è©³ç´°URL: ${location.href}` : '',
            jobSiteAddress ? `ç¾å ´ä½æ‰€: ${jobSiteAddress}` : '',
            // meetingPlace removed
            itemsAndAttire ? `\n${itemsAndAttire}` : '' // Add newline before if it exists
        ];
        // Join non-empty lines with double newlines for readability in the description
        const detailsText = detailsLines.filter(line => line.trim() !== '').join('\n\n');
        if (detailsText) calendarUrl.searchParams.set('details', detailsText);

        // å ´æ‰€ (Location) - Use job site address if available
        if (jobSiteAddress) calendarUrl.searchParams.set('location', jobSiteAddress);

        // æ—¥æ™‚ (Dates) - Mandatory for calendar event
        const startDateTime = formatDateTimeForCalendar(date, startTime, 0);
        const endDateTime = formatDateTimeForCalendar(date, endTime, endTimeDayAdjustment);

        if (startDateTime && endDateTime) {
            calendarUrl.searchParams.set('dates', `${startDateTime}/${endDateTime}`);
        } else {
            console.error('[e-NextLevel Calendar] Failed to format valid start/end dateTimes for calendar URL.');
            return ''; // Date/Time formatting failed, cannot create a valid URL
        }

        console.log('[e-NextLevel Calendar] Generated Google Calendar URL:', calendarUrl.toString());
        return calendarUrl.toString();
    }

   /**
     * UIè¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®šã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã€‚
     * @param {HTMLElement} element - ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®šã™ã‚‹è¦ç´ 
     * @param {object} styles - é©ç”¨ã™ã‚‹CSSã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
     */
    function applyStyles(element, styles) {
        Object.assign(element.style, styles);
    }

    /**
     * æƒ…å ±ã‚’è¡¨ç¤ºã—ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ãƒœã‚¿ãƒ³ã‚’æŒã¤UIã‚’ä½œæˆã—ã¦ãƒšãƒ¼ã‚¸ã«è¿½åŠ ã—ã¾ã™ã€‚
     * @param {object} jobDetails - æŠ½å‡ºã•ã‚ŒãŸä»•äº‹æƒ…å ±
     * @param {string} calendarUrl - ç”Ÿæˆã•ã‚ŒãŸGoogle Calendar URL
     * @param {boolean} isInitiallyRegistered - åˆæœŸç™»éŒ²çŠ¶æ…‹
     * @param {string|null} registrationFlagKey - ç™»éŒ²çŠ¶æ…‹ã‚’ä¿å­˜ã™ã‚‹GM_setValueã®ã‚­ãƒ¼
     */
    function createAndAppendUI(jobDetails, calendarUrl, isInitiallyRegistered, registrationFlagKey) {
         if (!jobDetails) {
             console.warn('[e-NextLevel Calendar] Cannot create UI without job details.');
             return;
         }
         console.log('[e-NextLevel Calendar] Creating UI elements...');

         const {
             date, startTime, endTime, title, jobSiteAddress, requiredItems, dressCode
             // meetingPlace removed
         } = jobDetails;
         const endTimeDayAdjustment = calculateEndTimeDayAdjustment(startTime, endTime);

         // --- UIã‚³ãƒ³ãƒ†ãƒŠ ---
         const uiContainer = document.createElement('div');
         uiContainer.id = 'enextlevel-calendar-ui'; // Add an ID for easier debugging/styling
         applyStyles(uiContainer, {
             position: 'fixed',
             top: '20px',
             right: '20px',
             zIndex: 10000,
             display: 'flex',
             flexDirection: 'column',
             gap: '12px', // Consistent spacing
             fontSize: '16px', // Base font size slightly smaller for better fit
             backgroundColor: 'rgba(255, 255, 255, 0.97)', // Slightly more opaque
             padding: '20px',
             border: '1px solid #cccccc', // Less prominent border
             maxWidth: '450px',
             maxHeight: 'calc(100vh - 40px)', // Adjust max height based on viewport
             overflowY: 'auto',
             borderRadius: '8px', // Slightly smaller radius
             boxShadow: '0 4px 10px rgba(0, 0, 0, 0.15)', // Softer shadow
             fontFamily: 'sans-serif' // Ensure consistent font
         });

         // --- æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ ---
         const infoDisplayElement = document.createElement('div');
         applyStyles(infoDisplayElement, {
             fontSize: '14px', // Smaller font for details
             lineHeight: '1.6',
             wordBreak: 'break-word'
         });
         // Use spans for potentially missing data for cleaner look
         const missingSpan = '<span style="color:#cc0000; font-style:italic;">æœªå–å¾—</span>';
         const nextDaySpan = '<span style="color: #cc0000; font-weight: bold;"> (ç¿Œæ—¥)</span>';
         infoDisplayElement.innerHTML = `
             <strong style="font-size: 16px; color: #3366cc; display: block; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">æŠ½å‡ºæƒ…å ±:</strong>
             æ—¥ä»˜: <strong>${date || missingSpan}</strong><br>
             é–‹å§‹: <strong>${startTime || missingSpan}</strong><br>
             çµ‚äº†: <strong>${endTime || missingSpan}</strong>${endTimeDayAdjustment ? nextDaySpan : ''}<br>
             ã‚¿ã‚¤ãƒˆãƒ«: <strong>${title || missingSpan}</strong><br>
             <div style="margin-top: 8px; padding-top: 8px; border-top: 1px dotted #ccc;">
             ç¾å ´ä½æ‰€: ${jobSiteAddress || 'æœªå–å¾—'}<br>
             æŒã¡ç‰©: ${requiredItems || 'æœªå–å¾—'}<br>
             æœè£…: ${dressCode || 'æœªå–å¾—'}
             </div>
         `;
         uiContainer.appendChild(infoDisplayElement);

         // --- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²ãƒœã‚¿ãƒ³ ---
         const calendarButton = document.createElement('button');
         calendarButton.textContent = 'ğŸ“… Google Calendarã«ç™»éŒ²';
         applyStyles(calendarButton, {
             padding: '12px 20px', // Slightly smaller padding
             background: '#34A853',
             color: 'white',
             border: 'none',
             borderRadius: '5px',
             cursor: 'pointer',
             fontSize: '15px', // Slightly smaller font size
             fontWeight: 'bold',
             textAlign: 'center',
             boxShadow: '0 2px 4px rgba(0, 0, 0, 0.2)',
             transition: 'background-color 0.2s ease, box-shadow 0.2s ease, transform 0.1s ease'
         });

         // URLç”Ÿæˆå¤±æ•—ã€ã¾ãŸã¯å¿…é ˆæƒ…å ±ä¸è¶³ã®å ´åˆã¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
         // Calendar URL generation already checks for essential info now
         const isButtonDisabled = !calendarUrl;
         calendarButton.disabled = isButtonDisabled;
         if (isButtonDisabled) {
             calendarButton.style.backgroundColor = '#bdbdbd'; // More distinct disabled color
             calendarButton.style.cursor = 'not-allowed';
             calendarButton.style.boxShadow = 'none';
             calendarButton.textContent = 'ğŸ“… ç™»éŒ²ä¸å¯ (æƒ…å ±ä¸è¶³/ã‚¨ãƒ©ãƒ¼)';
         } else {
              // Add hover/active effects only if enabled
              calendarButton.onmouseover = () => { calendarButton.style.backgroundColor = '#2c8a43'; };
              calendarButton.onmouseout = () => { calendarButton.style.backgroundColor = '#34A853'; };
              calendarButton.onmousedown = () => { calendarButton.style.transform = 'translateY(1px)'; calendarButton.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.3)'; };
              calendarButton.onmouseup = () => { calendarButton.style.transform = 'translateY(0)'; calendarButton.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.2)';};
         }


         // Defined registrationStatusElement here so it's available in the onclick scope
         const registrationStatusElement = document.createElement('div');

         calendarButton.onclick = () => {
             if (calendarButton.disabled) return;
             console.log('[e-NextLevel Calendar] Calendar button clicked! Opening URL:', calendarUrl);
             window.open(calendarUrl, '_blank');
             // ç™»éŒ²ãƒ•ãƒ©ã‚°ã‚­ãƒ¼ãŒã‚ã‚Œã°ã€ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã¦UIã‚’æ›´æ–°
             if (registrationFlagKey) {
                 GM_setValue(registrationFlagKey, true);
                 console.log(`[e-NextLevel Calendar] Set registration flag '${registrationFlagKey}' to true.`);
                 // registrationStatusElement is defined below, update it
                 updateRegistrationStatus(registrationStatusElement, true);
             }
         };
         uiContainer.appendChild(calendarButton);

         // --- ç™»éŒ²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º ---
         // registrationStatusElement was defined above
         applyStyles(registrationStatusElement, {
             textAlign: 'center',
             marginTop: '8px', // Reduced margin
             fontSize: '14px', // Smaller font size
             fontWeight: 'normal'
         });
         // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
         updateRegistrationStatus(registrationStatusElement, isInitiallyRegistered);
         console.log('[e-NextLevel Calendar] Status element created.');
         uiContainer.appendChild(registrationStatusElement);


         // --- UIã‚’ãƒšãƒ¼ã‚¸ã«è¿½åŠ  ---
         try {
             // Remove existing UI if script runs again (e.g., during development/debugging)
             const existingUI = document.getElementById('enextlevel-calendar-ui');
             if(existingUI) {
                 existingUI.remove();
             }
             document.body.appendChild(uiContainer);
             console.log('[e-NextLevel Calendar] UI container appended to document body.');
         } catch (e) {
             console.error('[e-NextLevel Calendar] Error appending UI container:', e);
         }
     }

    /**
     * ç™»éŒ²ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã™ã€‚
     * @param {HTMLElement} statusElement - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨ã®HTMLè¦ç´ 
     * @param {boolean} isRegistered - ç™»éŒ²æ¸ˆã¿ã‹ã©ã†ã‹
     */
    function updateRegistrationStatus(statusElement, isRegistered) {
        if (!statusElement) return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
        statusElement.textContent = isRegistered ? 'âœ… ç™»éŒ²æ¸ˆã¿' : 'ğŸ•’ æœªç™»éŒ²';
        statusElement.style.color = isRegistered ? '#2e7d32' : '#757575'; // Use specific colors
        statusElement.style.fontWeight = isRegistered ? 'bold' : 'normal';
        console.log('[e-NextLevel Calendar] Registration status updated:', statusElement.textContent);
    }

   /**
     * æƒ…å ±å–å¾—å¤±æ•—æ™‚ã«ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ©ãƒ¼UIã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     */
   function displayExtractionErrorUI() {
        const errorContainer = document.createElement('div');
        errorContainer.id = 'enextlevel-calendar-error-ui'; // Add ID
        applyStyles(errorContainer, {
            position: 'fixed', top: '20px', right: '20px', zIndex: 10000,
            padding: '10px 15px', background: 'rgba(255, 224, 224, 0.95)', border: '1px solid #cc0000',
            borderRadius: '5px', color: '#cc0000', fontSize: '14px', fontFamily: 'sans-serif'
        });
        errorContainer.textContent = 'ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç™»éŒ²: æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼';
        try {
             // Remove existing error UI if present
             const existingErrorUI = document.getElementById('enextlevel-calendar-error-ui');
             if(existingErrorUI) {
                 existingErrorUI.remove();
             }
            document.body.appendChild(errorContainer);
        } catch (e) {
             console.error('[e-NextLevel Calendar] Error appending error container:', e);
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    function main() {
        console.log('[e-NextLevel Calendar] Starting main execution...');
        // 1. ã‚¸ãƒ§ãƒ–IDã¨ç™»éŒ²çŠ¶æ…‹ã®å–å¾—
        const jobId = getJobIdFromUrl();
        const registrationFlagKey = jobId ? `${REGISTERED_FLAG_PREFIX}${jobId}` : null;
        let isInitiallyRegistered = false; // Default to false
        if (registrationFlagKey) {
             try {
                 isInitiallyRegistered = GM_getValue(registrationFlagKey, false);
             } catch (e) {
                  console.error("[e-NextLevel Calendar] Error getting GM_getValue:", e);
                  // Proceed with false, but log the error
             }
        }
        console.log(`[e-NextLevel Calendar] Job ID: ${jobId}, Flag Key: ${registrationFlagKey}, Initial Status: ${isInitiallyRegistered}`);

        // 2. ä»•äº‹è©³ç´°æƒ…å ±ã®æŠ½å‡º
        const jobDetails = extractJobDetails();

        // 3. æŠ½å‡ºæˆåŠŸæ™‚ã®ã¿URLç”Ÿæˆã¨UIä½œæˆã‚’è¡Œã†
        if (jobDetails) {
            // 3.1 Google Calendar URLã®ç”Ÿæˆ
            const calendarUrl = generateCalendarUrl(jobDetails);

            // 3.2 UIã®ä½œæˆã¨è¡¨ç¤º (URLç”Ÿæˆå¤±æ•—æ™‚ã¯ calendarUrl ãŒç©ºæ–‡å­—åˆ—ã«ãªã‚Šã€ãƒœã‚¿ãƒ³ãŒç„¡åŠ¹åŒ–ã•ã‚Œã‚‹)
            createAndAppendUI(jobDetails, calendarUrl, isInitiallyRegistered, registrationFlagKey);

        } else {
            console.error("[e-NextLevel Calendar] Could not extract job details. Displaying error UI.");
            // æƒ…å ±å–å¾—å¤±æ•—ã‚’ç¤ºã™UIã‚’è¡¨ç¤º
            displayExtractionErrorUI();
        }

        console.log('[e-NextLevel Calendar v1.9.2 Refactored] Script Finished');
    }

    // --- ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ ---
    // é…å»¶å®Ÿè¡Œã‚„DOMç›£è¦–ãŒå¿…è¦ãªå ´åˆã«è¿½åŠ å¯èƒ½ã ãŒã€@run-at document-idleã§é€šå¸¸ã¯ååˆ†
    // window.addEventListener('load', main); // Or use MutationObserver if content loads dynamically after initial idle
    main(); // Execute directly as run-at is document-idle

})();
